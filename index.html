<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TrueFastFix â€” Under Construction</title>
  <style>
    :root{--accent:#ff6600;--bg:#f9f9f9;--text:#333;--muted:#777}
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--text);margin:0;padding:0;text-align:center}
    h1{font-size:44px;color:var(--accent);margin:40px 0 10px}
    p.lead{font-size:18px;margin:0 0 30px}
    .hero img{max-width:900px;width:95%;height:auto}
    .chat-launcher{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#fff;border:none;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,.18);cursor:pointer;font-size:26px}
    .chat-panel{position:fixed;right:18px;bottom:86px;width:320px;max-width:calc(100vw-36px);background:#fff;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.18);overflow:hidden;display:none}
    .chat-header{background:#fff;border-bottom:1px solid #eee;padding:10px 12px;display:flex;align-items:center;justify-content:space-between}
    .chat-log{height:260px;overflow:auto;padding:12px;background:#fafafa;text-align:left;font-size:14px}
    .msg{padding:8px 10px;border-radius:8px;margin:6px 0;max-width:90%}
    .msg.me{background:#e7f3ff;align-self:flex-end;margin-left:auto}
    .msg.bot{background:#fff;border:1px solid #eee}
    .chat-form{display:flex;gap:8px;padding:10px;border-top:1px solid #eee}
    .chat-input{flex:1;padding:9px 10px;border:1px solid #ddd;border-radius:8px;font-size:14px}
    .chat-send{padding:9px 12px;border:none;border-radius:8px;background:var(--accent);color:#fff;cursor:pointer}
    .turnstile-wrap{height:0;overflow:hidden}
    .debug-line{font-size:12px;color:#444;padding:8px 12px;background:#fff;border-top:1px solid #eee;text-align:left;max-height:88px;overflow:auto}
  </style>

  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
  <h1>TrueFastFix</h1>
  <p class="lead">Our website is currently under construction. Please check back soon.</p>

  <div class="hero">
    <img src="under_construction_cartoon.png?v=2" alt="Under Construction Illustration">
  </div>

  <button class="chat-launcher" id="openChat" aria-label="Chat">ðŸ¤–</button>

  <section class="chat-panel" id="chatPanel" aria-live="polite">
    <div class="chat-header">
      <div style="font-weight:600">TrueFastFix Assistant</div>
      <button id="closeChat" aria-label="Close">Ã—</button>
    </div>

    <div class="chat-log" id="chatLog">
      <div class="msg bot">Hi! How can I help today?</div>
    </div>

    <form class="chat-form" id="chatForm">
      <input class="chat-input" id="chatInput" placeholder="Type your questionâ€¦" autocomplete="off"/>
      <button class="chat-send" type="submit">Send</button>
    </form>

    <div class="debug-line" id="debugLine">Debug: (no activity yet)</div>

    <div class="turnstile-wrap" aria-hidden="true">
      <div id="ts-widget" class="cf-turnstile"
           data-sitekey="0x4AAAAAAB2jA59QkctxTIe0"
           data-size="invisible"
           data-callback="truefastfix_ts_cb"></div>
    </div>
  </section>

<script>
  const openBtn = document.getElementById('openChat');
  const closeBtn = document.getElementById('closeChat');
  const panel = document.getElementById('chatPanel');
  const chatLog = document.getElementById('chatLog');
  const form = document.getElementById('chatForm');
  const input = document.getElementById('chatInput');
  const debugLine = document.getElementById('debugLine');

  openBtn.addEventListener('click', () => panel.style.display = 'block');
  closeBtn.addEventListener('click', () => panel.style.display = 'none');

  let tsWidgetId = null;
  let lastToken = "";
  window.truefastfix_ts_cb = (token) => {
    lastToken = token || "";
    debugLine.textContent = 'Debug: Turnstile callback token received.';
  };

  (function renderTurnstileOnce() {
    const el = document.getElementById('ts-widget');
    if (window.turnstile && el && tsWidgetId === null) {
      tsWidgetId = window.turnstile.render(el, {
        sitekey: "0x4AAAAAAB2jA59QkctxTIe0",
        size: "invisible",
        callback: truefastfix_ts_cb
      });
    } else {
      setTimeout(renderTurnstileOnce, 500);
    }
  })();

  function addMsg(text, who) {
    const div = document.createElement('div');
    div.className = 'msg ' + (who || 'bot');
    div.textContent = text;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;
    addMsg(message, 'me');
    input.value = '';

    debugLine.textContent = 'Debug: attempting Turnstile execute...';

    let token = lastToken || "";
    if (window.turnstile && tsWidgetId !== null) {
      try {
        window.turnstile.execute(tsWidgetId);
        token = await new Promise((resolve) => {
          let tries = 0;
          const iv = setInterval(() => {
            if (lastToken) { clearInterval(iv); resolve(lastToken); }
            tries++;
            if (tries > 20) { clearInterval(iv); resolve(lastToken || ""); }
          }, 100);
        });
      } catch (err) {
        console.warn("Turnstile execute error:", err);
      }
    }

    if (!token) {
      debugLine.textContent = 'Debug: No Turnstile token available.';
    } else {
      debugLine.textContent = 'Debug: Token obtained, sending to server...';
    }

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, turnstileToken: token })
      });

      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch(e) {}

      if (!res.ok) {
        debugLine.textContent = `Server error ${res.status}: ${text}`;
        addMsg(`Couldn't verify you're human. Server returned ${res.status}. See debug.`, 'bot');
        return;
      }

      debugLine.textContent = `Server OK ${res.status}: ${JSON.stringify(data)}`;
      const reply = (data && (data.reply || data.error || JSON.stringify(data))) || text;
      addMsg(reply, 'bot');

      lastToken = "";
      if (window.turnstile && tsWidgetId !== null && window.turnstile.reset) {
        try { window.turnstile.reset(tsWidgetId); } catch(e) {}
      }
    } catch (err) {
      debugLine.textContent = 'Client error: ' + (err.message || err);
      addMsg('Error: Load failed', 'bot');
    }
  });
</script>
</body>
</html>
